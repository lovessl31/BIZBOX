<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BIZBOX : 회원가입</title>
    <!-- Reset CSS -->
    <link rel="stylesheet" href="./css/reset.css">
    <!-- Pretendard Font -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/variable/pretendardvariable.css">
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="./css/style.css">
</head>
<body>
    <!-- 헤더 영역 -->
    <div class="header">
        <div class="container">
            <div class="row">
                <div class="col-12">
                    <div class="inner">
                        <h1><a href="index.html"><img src="./images/logo.png" alt="Logo"></a></h1>
                        <ul class="nav">
                            <li class="ms-3" id="nav-login"><a href="login.html">로그인</a></li>
                            <li class="ms-3" id="nav-logout" style="display: none;"><a href="#">로그아웃</a></li>
                            <li class="ms-3" id="nav-signup"><a href="join.html">회원가입</a></li>
                            <li class="ms-3"><a href="service.html">서비스신청</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 회원가입 영역 -->
    <div class="joinWrap">
        <div class="container">
            <div class="row">
                <div class="col-12">
                    <div class="joinContent">
                        <h3>회원가입</h3>
                        <div class="form_container">
                            <div class="rowInput">
                                <div class="floating">
                                    <input class="required" id="userId" type="text" name="account_name" required>
                                    <label>아이디</label>
                                    <span class="error-message" id="userIdError"></span>
                                </div>
                            </div>
                            <div class="rowInput">
                                <div class="floating">
                                    <input id="password" class="required" type="password" name="account_name" required>
                                    <label>비밀번호</label>
                                    <span class="error-message"></span>
                                </div>
                            </div>
                            <div class="rowInput">
                                <div class="floating">
                                    <input id="confirmPassword" class="required" type="password" name="account_name" required>
                                    <label>비밀번호 확인</label>
                                    <span id="passwordError" class="error-message"></span>
                                    </span>
                                </div>
                            </div>
                            <div class="rowInput">
                                <div class="floating">
                                    <input class="required" id="emailInput" type="text" name="account_name" required>
                                    <label>이메일</label>
                                    <span class="error-message" id="emailError"></span>
                                </div>
                            </div>
                            <div class="rowInput">
                                <div class="floating">
                                    <input class="required" type="text" name="account_name" id="name" required>
                                    <label>이름</label>
                                    <span class="error-message"></span>
                                </div>
                            </div>
                            <div class="rowInput">
                                <div class="floating">
                                    <input id="phoneNumber" class="required" type="text" name="account_name" required>
                                    <label>휴대폰번호</label>
                                    <span id="phoneError" class="error-message"><img src="./images/alert.svg">휴대폰 번호는 숫자만 입력 가능합니다.</span>
                                </div>
                                </div>
                                <button id="submitBtn">가입하기</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 푸터 영역 -->
    <div class="footer">
        <div class="container">
            <div class="row">
                <div class="col-12">
                    <div class="footerBox">
                        <div class="top">
                            <img src="./images/logo_footer.png">
                            <div class="sub">
                                위드퍼스트
                                <span class="bar"></span>
                                대표이사: 김태환
                                <span class="bar"></span>
                                사업자등록번호 <br>
                                주소 : 전라남도 나주시  우정로 10, 라동 304호
                                <span class="bar"></span>
                                이메일: withfirst01@gmail.com
                            </div>
                        </div>
                        <hr>
                        <div class="bot">
                            <div class="left">
                                <p>©withfirst All rights reserved.</p>
                            </div>
                            <div class="right">
                                <a href="#">이용약관</a>
                                <span class="bar"></span>
                                <a href="#">개인정보처리방침</a>
                                <span class="bar"></span>
                                <a href="#">사업자정보확인</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-latest.min.js"></script>
    <!-- Popper.js -->
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js" integrity="sha384-IQsoLXl5PILFhosVNubq5LC7Qb9DXgDA9i+tQ8Zj3iwWAwPtgFTxbJ8NT4GN1R8p" crossorigin="anonymous"></script>
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.min.js" integrity="sha384-cVKIPhGWiC2Al4u+LWgxfKTRIcfu0JTxR+EQDz/bgldoEyl4H0zUF0QKbrJ0EcQF" crossorigin="anonymous"></script>
    <script src="./js/script.js"></script>
    <script>
        $(document).ready(function() {
            const $submitBtn = $('#submitBtn');
            const $userIdInput = $('#userId'); // 아이디
            const $userIdError = $('#userIdError'); 
            const $emailInput = $('#emailInput'); // 이메일
            const $emailError = $('#emailError');
            const $passwordInput = $('#password'); // 비밀번호
            const $confirmPasswordInput = $('#confirmPassword');
            const $passwordError = $('#passwordError');
            const $phoneNumberInput = $('#phoneNumber'); // 핸드폰번호
            const $phoneError = $('#phoneError');
            const $nameInput = $('#name'); // 이름
            
            // 가입하기 버튼 클릭 시 유효성 검사 및 서버로 데이터 전송
            $submitBtn.on('click', function(event) {
                event.preventDefault();
                let isValid = true; // 유효성 검사 통과 했는지 확인

                // 필수 입력 필드 각각에 대해 유효성 검사
                $('.required').each(function() {
                    const $input = $(this); 
                    
                    if ($input.attr('id') === 'phoneNumber') {
                        if (!validatePhoneNumber($input)) {
                            isValid = false;
                        }
                    } else if ($input.attr('id') === 'emailInput') {
                        if (!validateEmail($input)) {
                            isValid = false;
                        }
                    } else if ($input.attr('id') === 'userId') {
                        if (!validateUserId ($input)) {
                            isValid = false;
                        }
                    } else if ($input.attr('id') === 'password') {
                        if (!validatePassword($input)) {
                            isValid = false;
                        }
                    } else if ($input.attr('id') === 'confirmPassword') {
                        if ($passwordInput.val() !== $confirmPasswordInput.val()) {
                            $confirmPasswordInput.addClass('input-error');
                            $passwordError.html('<img src="./images/alert.svg" alt="Alert"> 비밀번호가 일치하지 않습니다.').show();
                            isValid = false;
                        } else {
                            $confirmPasswordInput.removeClass('input-error');
                            $passwordError.hide();
                        }
                    } else {
                        if (!validateInput($input)) {
                            isValid = false;
                        }
                    }
                });

                if (isValid) {
                    const formData = new FormData();
                    formData.append('id', $userIdInput.val().trim());
                    formData.append('email', $emailInput.val().trim());
                    formData.append('password', $passwordInput.val().trim());
                    formData.append('name', $nameInput.val().trim());
                    formData.append('phone_number', $phoneNumberInput.val().trim());

                    $.ajax({
                        url: 'http://192.168.0.18:3001/biz/signup',
                        type: 'POST',
                        processData: false,
                        contentType: false,
                        data: formData,
                        success: function(response) {
                            alert('회원가입이 완료되었습니다.');
                            // 회원가입 완료 후 로그인 페이지로 이동
                            window.location.href='login.html';
                        },
                        error: function(xhr, status, error) {
                            alert('회원가입 중 오류가 발생했습니다.');
                            console.error('AJAX error:', status, error);
                        }
                    });
                }
            });


            // 아이디 중복 체크 함수
            function checkUserIdAvailability(userId) {
            return new Promise(resolve => {
                $.ajax({
                    url: `http://192.168.0.18:3001/biz/check-id?id=${encodeURIComponent(userId)}`,
                    type: 'GET',
                    success: function(res) {
                        console.log('AJAX response:', res); // 응답을 콘솔에 출력하여 확인
                        console.log(res.data[0] == '이');
                        if (res.data[0] == '이'){
                            let isAvailable = false
                            resolve(isAvailable)
                        } else if (res.data[0] == '존') {
                            let isAvailable =true
                            resolve(isAvailable)
                        }
                        else {
                            let isAvailable = true
                            resolve(isAvailable) 
                        }
                    },
                    error: function(xhr, status, error) {
                        console.error('AJAX error:', status, error); // 에러를 콘솔에 출력하여 확인
                        resolve(false); // 오류 발생 시 중복으로 처리
                    }
                });
            });
        }

        // 아이디 유효성 검사 함수
        function validateUserId($input) {
            const userId = $input.val().trim();
            const $errorSpan = $input.siblings('.error-message');
            
            if (userId === '') {
                $input.addClass('input-error');
                $errorSpan.html('<img src="./images/alert.svg" alt="Alert"> 아이디를 입력해주세요!').show();
                return false;
            } else if (userId.length < 4) { // 예시로 길이 제한을 4자 이상으로 설정
                $input.addClass('input-error');
                $errorSpan.html('<img src="./images/alert.svg" alt="Alert"> 아이디는 최소 4자 이상이어야 합니다.').show();
                return false;
            } else if (!/^[a-zA-Z0-9]+$/.test(userId)) {
                $input.addClass('input-error');
                $errorSpan.html('<img src="./images/alert.svg" alt="Alert"> 아이디는 영문 소문자, 대문자, 숫자만 포함 가능합니다.').show();
                return false;
            } else {
                // 아이디 중복 체크
                return checkUserIdAvailability(userId).then(isAvailable => {
                console.log("isAvailable", isAvailable);
                    if (isAvailable === false) {
                        $input.addClass('input-error');
                        $errorSpan.addClass('error-message');
                        $errorSpan.removeClass('success-message');
                        $errorSpan.html('<img src="./images/alert.svg" alt="Alert"> 아이디가 이미 등록되어 있습니다!').show();
                        return false;
                    } else {
                        $errorSpan.addClass('success-message');
                        $input.removeClass('input-error');
                        $errorSpan.html('<img src="./images/checked.svg" alt="Checked"> 사용할 수 있는 아이디입니다!').show();
                        return true;
                    }
                });
            }
        }

        // 아이디 입력 필드에서 입력할 때와 포커스를 잃을 때 유효성 검사 추가
        $userIdInput.on('blur', function() {
            validateUserId($userIdInput);
        });


        // 비밀번호 유효성 검사 함수 업데이트
        function validatePassword($input) {
            const password = $input.val().trim();
            const $errorSpan = $input.siblings('.error-message');
            const specialRegex = /[!@#$%^&*(),.?":{}|<>]/;
            const upperRegex = /[A-Z]/;
            
            if (password === '') {
                $input.addClass('input-error');
                $errorSpan.html('<img src="./images/alert.svg" alt="Alert"> 비밀번호를 입력해주세요!').show();
                return false;
            } else if (password.length < 8 || !specialRegex.test(password) || !upperRegex.test(password)) {
                $input.addClass('input-error');
                $errorSpan.html('<img src="./images/alert.svg" alt="Alert"> 비밀번호는 최소 8자 이상, 대문자를 포함하고, 특수문자를 포함해야 합니다.').show();
                return false;
            } else {
                $input.removeClass('input-error');
                $errorSpan.hide();
                return true;
            }
        }

        function checkPasswordMatch() {
            if ($passwordInput.val() === $confirmPasswordInput.val()) {
                $confirmPasswordInput.removeClass('input-error').addClass('input-success');
                $passwordError.removeClass('error-message').addClass('success-message');
                $passwordError.html('<img src="./images/checked.svg" alt="Checked"> 비밀번호가 일치합니다.').show();
            } else {
                $confirmPasswordInput.removeClass('input-success').addClass('input-error');
                $passwordError.removeClass('success-message').addClass('error-message');
                $passwordError.html('<img src="./images/alert.svg" alt="Alert"> 비밀번호가 일치하지 않습니다.').show();
            }
        }

        // 비밀번호 및 비밀번호 확인 필드 이벤트 리스너 추가
        $passwordInput.add($confirmPasswordInput).on('input', function() {
            validatePassword($passwordInput);
            if ($confirmPasswordInput.val() !== '') {
                checkPasswordMatch();
            } else {
                $passwordError.hide();
            }
        });

        // 비밀번호 확인 필드 포커스 벗어 났을 때 효과 제거
        $passwordInput.add($confirmPasswordInput).on('blur', function() {
            validatePassword($passwordInput);
            if ($passwordInput.val() === $confirmPasswordInput.val()) {
                $passwordError.hide();
                $confirmPasswordInput.removeClass('input-error input-success');
                $passwordError.removeClass('error-message success-message');
            } else if ($confirmPasswordInput.val() !== '') {
                checkPasswordMatch();
            }
        });

        // 이메일 중복 체크 함수
        function checkEmailAvailability(email) {
            return new Promise(resolve => {
                $.ajax({
                    url: `http://192.168.0.18:3001/biz/check-email?email=${encodeURIComponent(email)}`,
                    type: 'GET',
                    success: function(res) {
                        console.log('AJAX response:', res); // 응답을 콘솔에 출력하여 확인
                        status = ""
                        console.log(res.data[0]);
                        console.log(res.data[1]);
                        console.log(res.data[0] == '이');
                        if (res.data[0] == '이'){
                            let isAvailable = false
                            resolve(isAvailable)
                        } else if (res.data[0] == '존') {
                            let isAvailable =true
                            resolve(isAvailable)
                        }
                        else {
                            let isAvailable = true
                            resolve(isAvailable) 
                        }
                    },
                    error: function(xhr, status, error) {
                        console.error('AJAX error:', status, error); // 에러를 콘솔에 출력하여 확인
                        resolve(false); // 오류 발생 시 중복으로 처리
                    }
                });
            });
         }
        
        // 이메일 형식 검사 함수 업데이트
        function isValidEmailFormat(email) {
            const emailRegex = /^[a-zA-Z0-9]{3,20}@[a-zA-Z0-9]{3,12}\.[a-zA-Z]{2,12}$/;
            return emailRegex.test(email);
        }
        
             // 이메일 유효성 검사
             function validateEmail($input) {
            const email = $input.val().trim();
            const $errorSpan = $input.siblings('.error-message');
            
            if (email === '') {
                $input.addClass('input-error');
                $errorSpan.html('<img src="./images/alert.svg" alt="Alert"> 이메일을 입력해주세요!').show();
                return false;
            } else if (!isValidEmailFormat(email)) {
                $input.addClass('input-error');
                $errorSpan.html('<img src="./images/alert.svg" alt="Alert"> 올바른 이메일 형식이 아닙니다!').show();
                return false;
            } else {
                
            // 이메일 중복 체크
            return checkEmailAvailability(email).then(isAvailable => {
                console.log("isAvailable", isAvailable);
                    if (isAvailable === false) {
                        $input.addClass('input-error');
                        $errorSpan.addClass('error-message');
                        $errorSpan.removeClass('success-message');
                        $errorSpan.html('<img src="./images/alert.svg" alt="Alert"> 이메일이 이미 등록되어 있습니다!').show();
                        return false;
                    } else {
                        $errorSpan.addClass('success-message');
                        $input.removeClass('input-error');
                        $errorSpan.html('<img src="./images/checked.svg" alt="Checked"> 사용할 수 있는 이메일입니다!').show();
                        return true;
                    }
                });
            }
        }
        
        // 이메일 입력 후 포커스 아웃 시 중복 체크
        $emailInput.on('blur', function() {
            validateEmail($emailInput);
        });


        // 휴대폰 번호 유효성 검사
        function validatePhoneNumber($input) {
            const originalValue = $input.val();
            const numericValue = originalValue.replace(/\D/g, '');
            const $errorSpan = $('#phoneError');
            
            if (originalValue !== numericValue) {
                $input.addClass('input-error');
                $errorSpan.html('<img src="./images/alert.svg" alt="Alert"> 휴대폰 번호는 숫자만 입력 가능합니다.').show();
                return false;
            } else if (numericValue.length !== 11) {
                $input.addClass('input-error');
                $errorSpan.html('<img src="./images/alert.svg" alt="Alert"> 휴대폰 번호는 11자리여야 합니다.').show();
                return false;
            } else {
                $input.removeClass('input-error');
                $errorSpan.hide();
                return true;
            }
        }
        
        // 휴대폰 번호 입력 시 유효성 검사
        $('.required').on('input', function() {
            const $input = $(this);
            if ($input.attr('id') === 'phoneNumber') {
                validatePhoneNumber($input);
            } else {
                validateInput($input);
            }
        });
        
        // 휴대폰 번호 유효성 검사
        $phoneNumberInput.on('input', function() {
            validatePhoneNumber($phoneNumberInput);
        });
        
        $phoneNumberInput.on('blur', function() {
            validatePhoneNumber($phoneNumberInput);
        });
        
        // 입력 유효성 검사
        function validateInput($input) {
            const $errorSpan = $input.siblings('.error-message');
            if ($input.val().trim() === '') {
                $input.addClass('input-error');
                $errorSpan.html('<img src="./images/alert.svg" alt="Alert"> 값을 입력해주세요!').show();
                return false;
            } else {
                $input.removeClass('input-error');
                $errorSpan.hide();
                return true;
            }
        }       

        // 포커스 시 경고 숨김
        $('.required').on('focus', function() {
        const $input = $(this);
        const $errorSpan = $input.siblings('.error-message');
        $input.removeClass('input-error');
        $errorSpan.hide();
        });
    });
    </script>
</body>
</html>